<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1420 820" role="img"
  aria-labelledby="title desc">
  <title id="title">Downstream token validation flow</title>
  <desc id="desc">Forest issues a scoped bearer token and the agent validates claim and signature
    checks before allow or deny.</desc>
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#f8fafc" />
      <stop offset="100%" stop-color="#eff6ff" />
    </linearGradient>
    <marker id="arrow" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto">
      <path d="M0,0 L12,4 L0,8 z" fill="#1e293b" />
    </marker>
    <style>
      .title { font: 700 34px 'Segoe UI', Roboto, Arial, sans-serif; fill: #111827; }
      .subtitle { font: 500 18px 'Segoe UI', Roboto, Arial, sans-serif; fill: #334155; }
      .node { stroke-width: 2; rx: 16; ry: 16; }
      .forest { fill: #dcfce7; stroke: #15803d; }
      .agent { fill: #e0f2fe; stroke: #0369a1; }
      .audit { fill: #ede9fe; stroke: #6d28d9; }
      .allow { fill: #ecfdf5; stroke: #059669; }
      .deny { fill: #fef2f2; stroke: #dc2626; }
      .boxTitle { font: 700 22px 'Segoe UI', Roboto, Arial, sans-serif; fill: #0f172a; }
      .text { font: 500 15px 'Segoe UI', Roboto, Arial, sans-serif; fill: #334155; }
      .check { font: 600 15px 'Segoe UI', Roboto, Arial, sans-serif; fill: #0f172a; }
      .arrow { stroke: #1e293b; stroke-width: 2.8; fill: none; marker-end: url(#arrow); }
      .arrowText { font: 700 16px 'Segoe UI', Roboto, Arial, sans-serif; fill: #ffffff; }
      .circleBadge { fill: #1e293b; }
      .legendBox { fill: #ffffff; stroke: #cbd5e1; stroke-width: 1.5; rx: 8; ry: 8; }
      .legendText { font: 500 15px 'Segoe UI', Roboto, Arial, sans-serif; fill: #334155; }
      .tokenNote { fill: #ffffff; stroke: #64748b; stroke-width: 1.8; rx: 12; ry: 12; }
      .tokenText { font: 500 14px 'Consolas', Menlo, Monaco, monospace; fill: #1f2937; }
    </style>
  </defs>

  <rect width="1420" height="820" fill="url(#bg)" />
  <text x="52" y="62" class="title">Downstream Bearer Token Validation (RFC6750)</text>
  <text x="52" y="90" class="subtitle">Forest issues; agent validates; decision is explicit and
    auditable</text>

  <rect x="72" y="234" width="322" height="196" class="node forest" />
  <text x="96" y="278" class="boxTitle">Frontend (Client)</text>
  <text x="96" y="306" class="text">Receives scoped token from Forest</text>
  <text x="96" y="332" class="text">Presents token to Customer Agent</text>
  <text x="96" y="358" class="text">Sent over TLS connection</text>

  <rect x="496" y="190" width="420" height="308" class="node agent" />
  <text x="522" y="234" class="boxTitle">Customer-Hosted Agent Auth</text>
  <text x="522" y="266" class="check">Checks:</text>
  <text x="522" y="292" class="check">1) Signature and trusted issuer key</text>
  <text x="522" y="318" class="check">2) iss + aud exact match</text>
  <text x="522" y="344" class="check">3) exp/nbf and allowed clock skew</text>
  <text x="522" y="370" class="check">4) tenant_id + scope policy</text>
  <text x="522" y="396" class="check">5) Optional replay control on jti</text>
  <text x="522" y="422" class="check">6) Correlated auth event logging</text>

  <rect x="980" y="170" width="352" height="124" class="node audit" />
  <text x="1004" y="214" class="boxTitle">Audit + Metrics</text>
  <text x="1004" y="242" class="text">reason_code, tenant, principal, jti</text>
  <text x="1004" y="266" class="text">latency, deny counters, signature errors</text>

  <rect x="980" y="364" width="352" height="124" class="node allow" />
  <text x="1004" y="408" class="boxTitle">ALLOW</text>
  <text x="1004" y="436" class="text">Proceed to agent handlers</text>

  <rect x="980" y="560" width="352" height="124" class="node deny" />
  <text x="1004" y="604" class="boxTitle">DENY</text>
  <text x="1004" y="632" class="text">Return 401/403 with deterministic reason</text>

  <path d="M394 300 L496 300" class="arrow" />
  <circle cx="445" cy="300" r="12" class="circleBadge" />
  <text x="445" y="305" class="arrowText" text-anchor="middle">1</text>

  <path d="M916 248 L980 230" class="arrow" />
  <circle cx="948" cy="239" r="12" class="circleBadge" />
  <text x="948" y="244" class="arrowText" text-anchor="middle">2</text>

  <path d="M916 402 L980 422" class="arrow" />
  <circle cx="948" cy="412" r="12" class="circleBadge" />
  <text x="948" y="417" class="arrowText" text-anchor="middle">3</text>

  <path d="M916 452 L980 622" class="arrow" />
  <circle cx="948" cy="537" r="12" class="circleBadge" />
  <text x="948" y="542" class="arrowText" text-anchor="middle">4</text>

  <rect x="980" y="700" width="352" height="120" class="legendBox" />
  <text x="996" y="728" class="legendText"><tspan font-weight="700">1.</tspan> Auth: Bearer
    &lt;token&gt; over TLS</text>
  <text x="996" y="752" class="legendText"><tspan font-weight="700">2.</tspan> Emit auth decision
    event</text>
  <text x="996" y="776" class="legendText"><tspan font-weight="700">3.</tspan> All checks pass</text>
  <text x="996" y="800" class="legendText"><tspan font-weight="700">4.</tspan> Any check fails</text>

  <rect x="72" y="514" width="844" height="186" class="tokenNote" />
  <text x="96" y="548" class="tokenText">{</text>
  <text x="126" y="548" class="tokenText">"iss":"forest-admin", "aud":"agent-x", "sub":"user-123",</text>
  <text x="126" y="576" class="tokenText">"tenant_id":"tenant-a", "scope":"records:read",</text>
  <text x="126" y="604" class="tokenText">"iat":..., "nbf":..., "exp":..., "jti":"..."</text>
  <text x="96" y="632" class="tokenText">}</text>
  <text x="96" y="668" class="text">Bearer constraint: possession equals usage. Keep TTL short and
    prevent token leakage in logs.</text>
</svg>
