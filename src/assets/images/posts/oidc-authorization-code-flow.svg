<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 780" role="img" aria-labelledby="title desc">
  <title id="title">OIDC authorization code flow</title>
  <desc id="desc">Detailed sequence showing browser, Forest Admin, and upstream OIDC provider interactions.</desc>
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#f8fafc"/>
      <stop offset="100%" stop-color="#eef2ff"/>
    </linearGradient>
    <marker id="arrow" markerWidth="12" markerHeight="8" refX="10" refY="4" orient="auto">
      <path d="M0,0 L12,4 L0,8 z" fill="#334155"/>
    </marker>
    <style>
      .title { font: 700 34px 'Segoe UI', Roboto, Arial, sans-serif; fill: #0f172a; }
      .subtitle { font: 500 18px 'Segoe UI', Roboto, Arial, sans-serif; fill: #334155; }
      .box { fill: #ffffff; stroke: #475569; stroke-width: 2; rx: 14; ry: 14; }
      .boxTitle { font: 700 21px 'Segoe UI', Roboto, Arial, sans-serif; fill: #0f172a; }
      .lifeline { stroke: #94a3b8; stroke-width: 2; stroke-dasharray: 8 8; }
      .msg { stroke: #334155; stroke-width: 2.8; fill: none; marker-end: url(#arrow); }
      .msgText { font: 600 14px 'Segoe UI', Roboto, Arial, sans-serif; fill: #1e293b; }
      .note { fill: #ecfeff; stroke: #0891b2; stroke-width: 1.8; rx: 10; ry: 10; }
      .noteText { font: 500 13px 'Segoe UI', Roboto, Arial, sans-serif; fill: #0c4a6e; }
    </style>
  </defs>

  <rect width="1400" height="780" fill="url(#bg)"/>
  <text x="52" y="62" class="title">OIDC Authorization Code Flow (Upstream Login)</text>
  <text x="52" y="90" class="subtitle">Forest acts as RP/OAuth client against the upstream OIDC provider</text>

  <rect x="96" y="122" width="258" height="76" class="box"/>
  <text x="126" y="168" class="boxTitle">Browser</text>

  <rect x="566" y="122" width="276" height="76" class="box"/>
  <text x="594" y="168" class="boxTitle">Forest Admin Server</text>

  <rect x="1018" y="122" width="286" height="76" class="box"/>
  <text x="1048" y="168" class="boxTitle">OIDC Provider</text>

  <line x1="224" y1="198" x2="224" y2="720" class="lifeline"/>
  <line x1="704" y1="198" x2="704" y2="720" class="lifeline"/>
  <line x1="1160" y1="198" x2="1160" y2="720" class="lifeline"/>

  <line x1="224" y1="248" x2="704" y2="248" class="msg"/>
  <text x="284" y="238" class="msgText">1. GET /login</text>

  <line x1="704" y1="294" x2="224" y2="294" class="msg"/>
  <text x="290" y="284" class="msgText">2. 302 to /authorize (client_id, redirect_uri)</text>

  <line x1="224" y1="340" x2="1160" y2="340" class="msg"/>
  <text x="368" y="330" class="msgText">3. /authorize (state, nonce, scope=openid)</text>

  <line x1="1160" y1="386" x2="224" y2="386" class="msg"/>
  <text x="476" y="376" class="msgText">4. User auth + consent UI</text>

  <line x1="224" y1="432" x2="704" y2="432" class="msg"/>
  <text x="290" y="422" class="msgText">5. callback?code=...&amp;state=...</text>

  <line x1="704" y1="478" x2="1160" y2="478" class="msg"/>
  <text x="774" y="468" class="msgText">6. POST /token (code, client auth, PKCE)</text>

  <line x1="1160" y1="524" x2="704" y2="524" class="msg"/>
  <text x="780" y="514" class="msgText">7. id_token + access_token (+ refresh_token)</text>

  <line x1="704" y1="570" x2="1160" y2="570" class="msg"/>
  <text x="794" y="560" class="msgText">8. JWKS lookup / signature validation</text>

  <line x1="704" y1="616" x2="224" y2="616" class="msg"/>
  <text x="324" y="606" class="msgText">9. Session established, redirect to app</text>

  <rect x="520" y="646" width="368" height="90" class="note"/>
  <text x="538" y="670" class="noteText">Mandatory checks at Forest boundary:</text>
  <text x="538" y="692" class="noteText">- issuer + audience + nonce/state correlation</text>
  <text x="538" y="714" class="noteText">- exp/nbf, signature, tenant claim mapping</text>
</svg>
